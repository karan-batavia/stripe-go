#!/bin/bash
# Usage: bin/generate-cpq-scratch-org
#        bin/generate-cpq-scratch-org your-unique-alias

# feature options:
# https://developer.salesforce.com/docs/atlas.en-us.222.0.sfdx_dev.meta/sfdx_dev/sfdx_dev_scratch_orgs_def_file_config_values.htm

# settings:
# https://developer.salesforce.com/docs/metadata-coverage/55

if [ -z "$DEVHUB_USER" ]; then
  DEVHUB_USER=$(sfdx force:config:get defaultdevhubusername --json | jq -r '.result[0].value')
fi
if [ -z "$DEVHUB_USER" ]; then
  DEVHUB_USER=pbo+billing@stripe.com
fi

cd "$(dirname "$0")/.."
source ../.env

if [ -z "$1" ]; then
  salesforceAlias="$(basename $HOME)"-scratch
else
  salesforceAlias=$1
fi

set -e -o pipefail


if [ ! -z "$CI" ]; then
  echo "This should only be run locally"
  exit 1
fi

if [[ -z $(which jq) ]]; then
  echo "run 'brew install jq'"
  exit 1
fi

if [[ $(sfdx config:get defaultdevhubusername --json | jq -r '.result[0].value') == "null" ]]; then
  echo "No default devhub set, using '$DEVHUB_USER'"
  sfdx config:set defaultdevhubusername=$DEVHUB_USER
else
  echo "Default devhub already set, skipping"
fi

# TODO should check if billing pbo is authorized. Run this if not:
# sfdx force:auth:web:login -a pbo+billing@stripe.com

# TODO consider adding additional features to the scratch def
# https://cs.github.com/SFDC-Assets/platform-events-demo/blob/a33c18a32dd8135060ccf69f2d84f003bac7a98e/config/project-scratch-def.json?q=path%3A*scratch-def.json+day#L5

echo "Using alias '$salesforceAlias'..."

# NOTE this will not work unless .sfdx/
# org will expire in 30d, there is no way around this
echo "Creating scratch org..."
sfdx force:org:create --loglevel=TRACE -f config/project-scratch-def.json -a $salesforceAlias -d 30 -w 15

# install CPQ package, pull package ID from: https://steelbrick2.force.com/InstallPremium (Spring 23 v242.2)
sfdx force:package:install -r --package 04t4N000000N6FFQA0 -w 30 -o $salesforceAlias
sfdx force:user:password:generate -o $salesforceAlias
sfdx force:user:display -o $salesforceAlias

echo "Setup complete."

if [[ $(sfdx config:get defaultusername --json | jq -r '.result[0].value') == "null" ]]; then
  echo "No default username set, using '$salesforceAlias'"
  sfdx config:set defaultusername=$salesforceAlias
else
  echo "Default username already set, skipping"
fi

# needs to be done before source:push since custom coupon object depend on this license
sfdx force:user:permsetlicense:assign -n 'Salesforce CPQ License' -u $salesforceAlias

sfdx config:set restDeploy=true apiVersion=56.0
sfdx force:source:push --loglevel=debug -o $salesforceAlias

# needs to be done after the source:push since this references custom perm sets
sfdx force:user:permset:assign -n "Stripe_Connector_Integration_User, Stripe_Connector_Sync_Management_User, Stripe_Connector_Coupon_User, Order_Permissions" -u $salesforceAlias

# create global key metadata
if [ -z "$SF_MANAGED_PACKAGE_API_KEY" ]; then
  echo -e "Managed package key is not yet, set up global key manually.\n"
  echo "# Connector Setup"
  echo -e "Manual step: Create global key. Label/Name: Default. Key: pull from SF_MANAGED_PACKAGE_API_KEY in your env.\n\n"
  sfdx force:org:open -o $salesforceAlias -p '/lightning/setup/CustomMetadata/page?address=%2Fm02%3Fsetupid%3DCustomMetadata' > /dev/null
else
  sed "s|____GLOBAL_KEY____|$SF_MANAGED_PACKAGE_API_KEY|" scripts/apex/create_global_key_metadata | sfdx force:apex:execute -o $salesforceAlias
fi

echo "# CPQ Setup"
# echo "Manual step: Installed Packages > Configure > Pricing & Calculation > Authorize"
echo "Manual step: Installed Packages > Configure > Pricing & Calculation > Enable Use Legacy Calculator (1st col, bottom)"
echo "Manual step: Installed Packages > Configure > Pricing & Calculation > Enable Usage Based Pricing (2nd col, middle)"
echo "Manual step: Installed Packages > Configure > Subscription & Renewals > Subscription Prorate Precision: Monthly + Daily"
echo "Manual step: Installed Packages > Configure > Subscription & Renewals > Contract in Foreground"
echo "Manual step: Installed Packages > Configure > Subscription & Renewals > Enable Evergreen Subscriptions"
echo "Manual step: Installed Packages > Configure > Subscription & Renewals > Enable Legacy Amend/Renew Service"
echo "Manual step: Installed Packages > Configure > Order > Default Order Start Date > Quote Start Date"
echo $'\n\n'
sfdx force:org:open -o $salesforceAlias -p "/lightning/setup/ImportedPackage/home" > /dev/null

echo "Opening up another tab to the Stripe app, authorize Salesforce & Stripe"
# open https://rest-na.steelbrick.com/oauth/auth/https%3A%2F%2Ftest.salesforce.com/SBQQ
# open https://salesforce.suitesync.io/auth/salesforcesandbox

echo "All done! Remember: this scratch org will expire in 30d, so have two of these ready so your dev loop is not destroyed."
echo "You probably want to refresh your development tokens: 'bundle exec ruby scripts/refresh-tokens.rb'"
echo "Try playing around in a console: 'bundle exec ruby scripts/console.rb'"

# TODO debug mode lwc, this looks like it cannot be setup automatically
# TODO assign permission set CPQ license https://sf9to5.com/2020/09/08/winter-21-changes-cpq-licensing/
# TODO make sure Stripe fields are on all layouts
# include example of how to delete the scratch org `sfdx force:org:delete -p -u test-motqqy6yl1qs@example.com`
# TODO if scratch org is expired, you will get auth issues. Remove with `sfdx auth:logout -u test-bpruhlkz0qaf@example.com`
#      even better: `sfdx force:org:list --clean`
# TODO the pricebooks aren't active by default, debugger => activate_pricebooks
# TODO document deployment status `/lightning/setup/DeployStatus/home`