#!/bin/bash

# feature options:
# https://developer.salesforce.com/docs/atlas.en-us.222.0.sfdx_dev.meta/sfdx_dev/sfdx_dev_scratch_orgs_def_file_config_values.htm

# settings:
# https://developer.salesforce.com/docs/metadata-coverage/55

set -e -o pipefail

cd "$(dirname "$0")/.."

if [ ! -z "$CI" ]; then
  echo "This should only be run locally"
  exit 1
fi

if [[ -z $(which jq) ]]; then
  echo "run 'brew install jq'"
  exit 1
fi

sfdx config:set defaultdevhubusername=pbo+billing@stripe.com

# TODO should check if billing pbo is authorized

# TODO consider adding additional features to the scratch def
# https://cs.github.com/SFDC-Assets/platform-events-demo/blob/a33c18a32dd8135060ccf69f2d84f003bac7a98e/config/project-scratch-def.json?q=path%3A*scratch-def.json+day#L5

if [ -z "$1" ]; then
  salesforceAlias="$(basename $HOME)"-scratch
else
  salesforceAlias=$1
fi

echo "Using alias '$salesforceAlias'..."

# NOTE this will not work unless .sfdx/
# org will expire in 30d, there is no way around this
echo "Creating scratch org..."
sfdx force:org:create --loglevel=TRACE -f config/project-scratch-def.json -a $salesforceAlias -d 30 -w 15

# install CPQ package, pull package ID from: https://steelbrick2.force.com/InstallPremium
sfdx force:package:install -r --package 04t4N000000xBcTQAU -w 30 -u $salesforceAlias

sfdx force:user:password:generate -u $salesforceAlias
sfdx force:user:display -u $salesforceAlias

echo "Setup complete."

if [[ $(sfdx config:get defaultusername --json | jq -r '.result[0].value') == "null" ]]; then
  echo "No default username set, using '$salesforceAlias'"
  sfdx config:set defaultusername=$salesforceAlias
else
  echo "Default username already set, skipping"
fi

sfdx config:set restDeploy=true
sfdx force:source:push --loglevel=debug --apiversion=54.0 -u $salesforceAlias

# needs to be done after the source:push since this references custom perm sets
sfdx force:user:permset:assign -n "Stripe_Connector_Integration_User, Stripe_Connector_Sync_Management_User, Order_Permissions" -u $salesforceAlias

echo "# CPQ Setup"
echo "Manual step: Installed Packages > Configure > Pricing & Calculation > Authorize"
echo "Manual step: Installed Packages > Configure > Pricing & Calculation > Enable Usage Based Pricing"
echo "Manual step: Installed Packages > Configure > Subscription & Renewals > Subscription Prorate Precision: Month"
echo "Manual step: Installed Packages > Configure > Subscription & Renewals > Contract in Foreground"
echo $'\n\n'
sfdx force:org:open -u $salesforceAlias -p "/lightning/setup/ImportedPackage/home" > /dev/null

echo "# Connector Setup"
echo "Manual step: Create global key. Label/Name: Default. Key: pull from env."
echo $'\n\n'
sfdx force:org:open -u $salesforceAlias -p '/lightning/setup/CustomMetadata/page?address=%2Fm02%3Fsetupid%3DCustomMetadata' > /dev/null

echo "Opening up another tab to the Stripe app"
sfdx force:org:open -u $salesforceAlias -p '/lightning/n/Setup' > /dev/null

echo "All done! Remember: this scratch org will expire in 30d, so have two of these ready so your dev loop is not destroyed."
echo "You probably want to refresh your development tokens: 'bundle exec ruby scripts/refresh-tokens.rb'"
echo "Try playing around in a console: 'bundle exec ruby scripts/console.rb'"

# TODO debug mode lwc, this looks like it cannot be setup automatically
# TODO assign permission set CPQ license https://sf9to5.com/2020/09/08/winter-21-changes-cpq-licensing/
# TODO make sure Stripe fields are on all layouts
# include example of how to delete the scratch org `sfdx force:org:delete -p -u test-motqqy6yl1qs@example.com`
# TODO the pricebooks aren't active by default, debugger => activate_pricebooks