#!/bin/bash

# Description: open up a separate VS code terminal and run this script so you'll never have expired credentials
# Usage: cd sfdx && bin/refresh-salesforce-credentials

set -e -o pipefail

if [ ! -z "$CI" ]; then
  echo "This should only be run locally"
  exit 1
fi

cd "$(dirname "$0")"
cd ..

while true; do
  echo "Refreshing..."
  # refresh the token; run any sfdx command
  sfdx force:limits:api:display > /dev/null

  # grab the default user
  # TODO this isn't perfect because we may be using a different username
  salesforceAlias=$(sfdx config:get defaultusername --json | jq -r '.result[0].value')

  # now let's refresh the system token
  cd ..
  bundle exec ruby scripts/refresh-tokens.rb $salesforceAlias

  # back where we started
  cd sfdx

  echo "Sleeping..."
  sleep 3600
done