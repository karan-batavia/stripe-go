#!/bin/bash

set -eu -o pipefail

if [ -z "$CI" ]; then
  echo "This should only be run on CircleCI"
  exit 1
fi

if ! command -v sfdx &> /dev/null
then
  echo "SFDX is not installed please follow this link to install"
  echo "https://developer.salesforce.com/docs/atlas.en-us.234.0.sfdx_setup.meta/sfdx_setup/sfdx_setup_install_cli.htm"
  exit 1
else
  echo "sfdx version installed:"
  sfdx --version
fi

./sfdx/bin/extract-private-key

cd sfdx
export SFDX_IMPROVED_CODE_COVERAGE=true

# ensure the same deploy approach is used to deploy locally, otherwise you'll run into strange errors
sfdx config:set restDeploy=true

# grab a `accessToken` from a auth'd account in ~/.sfdx/ to test this logic locally
# `sfdx auth:logout -u alias` to remove the org so can reauth

source ./bin/run-tests-helpers

authorizeSalesforceAccount "$1"
deploySource "$1"
runTests "$1"
deleteTestData "$1"