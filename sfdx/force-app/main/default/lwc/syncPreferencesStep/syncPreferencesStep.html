<template>
    <div class="slds-p-around_large">
        <lightning-button if:true={canDevReset} slot="actions" label="Reset" onclick={devReset}></lightning-button>
        <lightning-accordion>
            <lightning-accordion-section if:true={setupComplete} name="Activation" label="Activation Settings">
                <div class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Live Syncing
                        </h4>
                        <p>
                            Enable or disable the realtime syncing of orders to Stripe. Disabling this will effectively pause your integration, while allowing you to still use the manual translation features below.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3 slds-text-align_right">
                        <lightning-input type="toggle"
                                         label="Syncing Enabled"
                                         variant="label-hidden"
                                         checked={pollingEnabled}
                                         message-toggle-active=""
                                         message-toggle-inactive=""
                                         class="stripe-input_enable-integration slds-show_inline-block"
                                         onchange={updatePollingEnabled}>
                        </lightning-input>
                    </div>
                </div>

                <div class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Stripe Account
                        </h4>
                        <p>
                            The Stripe account connected to Salesforce. This account contains Stripe data being synced from your Salesforce account.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                        <lightning-input type="text" label="Stripe Account" value={stripeAccountId} variant="label-hidden" placeholder="No Stripe Account Found" disabled></lightning-input>
                    </div>
                </div>

                <div class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Sync Start Date
                        </h4>
                        <p>
                            The date on which Stripe data will begin syncing with Salesforce. This setting is progressive, meaning all relevant data from this date moving forward will be synced, while any data before the specified date will be ignored.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                        <lightning-input data-id="syncStartDate" label="Sync Start Date" type="date" date-style="short" variant="label-hidden" required={pollingEnabled} value={syncStartDate} onchange={updateSyncStartDate} placeholder="Select Sync Start Date..." disabled={hasSynced}></lightning-input>
                    </div>
                </div>

                <div class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Last Synced
                        </h4>
                        <p>
                            The last time Stripe data was synced with this Salesforce org.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                        <lightning-input label="Last Synced" type="text" variant="label-hidden" value={lastSynced} placeholder="N/A" disabled></lightning-input>
                    </div>
                </div>
            </lightning-accordion-section>
            <lightning-accordion-section name="Management" label="Management Settings">
                <div class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Billing Currency
                        </h4>
                        <p if:false={isMultiCurrencyEnabled}>
                            Currency to be used for Salesforce data being synced with Stripe. If you enable multiple currencies in your Salesforce organization, the currency specified on your price objects will be used.
                        </p>
                        <p if:true={isMultiCurrencyEnabled}>
                            Your organization has multiple currency support enabled. The currency specified on your price objects will be used.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                        <lightning-input if:false={isMultiCurrencyEnabled} type="text" label="Default Currency" value={defaultCurrency} variant="label-hidden" placeholder="N/A" disabled></lightning-input>
                    </div>
                </div>

                <div class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Sync Record Retention
                        </h4>
                        <p>
                            The number of sync records retained in your Salesforce org. A sync record is created each time Stripe data is synced with Salesforce.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                        <lightning-input label="Sync Record Retention" type="number" variant="label-hidden" value={syncRecordRetention} onchange={updateSyncRecordRetention} placeholder="Enter a Value..." max="1000000" min="100" step="1"></lightning-input>
                        <div class="slds-text-title slds-m-top_xx-small slds-p-left_xx-small">
                            Max 1,000,000 records, min 100 records
                        </div>
                    </div>
                </div>

                <c-sync-preferences-item name="api_percentage_limit" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                API Percentage Limit (%)
                            </h4>
                            <p>
                                The maximum percent of all available Salesforce API calls to be allocated to Stripe. Salesforce orgs have a limited number of API calls in a 24 hour period of time. If there are other call-intensive processes, consider reducing this setting to avoid hitting the org API limits.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <lightning-input label="API Percentage Limit (%)" type="number" formatter="percent-fixed" step="1" min="1" max="100" variant="label-hidden" value={apiPercentageLimit} onchange={updateApiPercentageLimit} placeholder="Set API Limit (%)..."></lightning-input>
                            <div class="slds-text-title slds-m-top_xx-small slds-p-left_xx-small">
                                Allowing {apiLimitCount} of {totalApiCalls} available API calls
                            </div>
                        </div>
                    </div>
                </c-sync-preferences-item>
                <c-sync-preferences-item if:true={isCpqInstalled} name="cpq_term_unit" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                CPQ Term Unit
                            </h4>
                            <p>
                                The unit of time used for subscription terms in your org. This value can be found in the <a href="/lightning/setup/ImportedPackage/home" target="_blank">Installed Packages <lightning-icon icon-name="utility:new_window" class="stripe-icon_inline slds-current-color" size="xx-small"></lightning-icon></a> section of your Salesforce Org Setup. Find the Salesforce CPQ package, click 'Configure' next to the package name, and navigate to 'Subscriptions and Renewals'. The 'Subscription Term Unit' is the value needed for this setting.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <c-picklist label="CPQ Term Interval" options={intervalOptions} variant="label-hidden" value={cpqTermUnit} onselect={updateCpqTermInterval} placeholder="Select Interval..." searchable></c-picklist>
                        </div>
                    </div>
                </c-sync-preferences-item>
                <c-sync-preferences-item if:true={isCpqInstalled} name="cpq_prorate_precision" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                CPQ Subscription Prorate Precision
                            </h4>
                            <p class="slds-m-bottom_xx-small">
                                Controls how to <a class="slds-m-right_xx-small" href="https://help.salesforce.com/s/articleView?id=sf.cpq_subscriptions_prorate_precision_1.htm&type=5" target=_blank>
                                calculate prorations<lightning-icon icon-name="utility:new_window" class="stripe-icon_inline slds-current-color slds-m-left_xx-small" size="xx-small"></lightning-icon></a>
                                for a Salesforce order item in your org. This value should be identical to the Salesforce CPQ
                                setting 'Subscription Prorate Precision'. By default, Salesforce CPQ uses 'Month'. Please note,
                                changing this values impacts proration invoices the connector creates.

                                You can find this field by navigating to <a class="slds-m-right_xx-small" href="/lightning/setup/ImportedPackage/home" target="_blank">Installed Packages
                                <lightning-icon icon-name="utility:new_window" class="stripe-icon_inline slds-current-color slds-m-left_xx-small" size="xx-small"></lightning-icon></a>
                                and selecting 'Configure' next to Salesforce CPQ package name.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <c-picklist label="CPQ Subscription Prorate Precision" options={prorateOptions} variant="label-hidden" value={cpqProratePrecision} onselect={updateCpqProratePrecision} placeholder="Select Prorate Precision..." searchable></c-picklist>
                        </div>
                    </div>
                </c-sync-preferences-item>
            </lightning-accordion-section>
            <lightning-accordion-section name="SyncFilters" label="Sync Filters">
                <c-sync-preferences-item name="order_filter" toggle-field-visibility-list={hiddenSyncPrefsFields} first>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                Custom Order Sync Conditions
                            </h4>
                            <p>
                                By default, all activated Orders will be synchronized to Stripe. To filter out additional orders, specify a SOQL <code>WHERE</code> clause here.
                                This custom query determines which Orders will be synchronized. Orders that do not meet the criteria defined here are excluded from the sync to Stripe.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <lightning-input label="Include Order records where:" type="text" value={orderFilter} placeholder="Provide filter logic..." class={orderFilterClassList} onchange={updateOrderFilter}></lightning-input>
                            <div if:true={hasOrderFilterError} class="slds-form-element__help slds-text-color_error">
                                {orderFilterError}
                            </div>
                        </div>
                    </div>
                </c-sync-preferences-item>
                <c-sync-preferences-item name="account_filter" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                Custom Account Sync Conditions
                            </h4>
                            <p>
                                If ongoing account updates is enabled on your account, account updates are synchronized to Stripe. To customize which types of accounts are kept up-to-date in Stripe, specify a SOQL <code>WHERE</code> clause here.
                                This custom query determines which accounts will be synchronized. Accounts that do not meet the criteria defined here are excluded from the sync to Stripe.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <lightning-input label="Include Account records where:" type="text" value={accountFilter} placeholder="Provide filter logic..." class={accountFilterClassList} onchange={updateAccountFilter}></lightning-input>
                            <div if:true={hasAccountFilterError} class="slds-form-element__help slds-text-color_error">
                                {accountFilterError}
                            </div>
                        </div>
                    </div>
                </c-sync-preferences-item>
                <c-sync-preferences-item name="product_filter" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                Custom Product Sync Conditions
                            </h4>
                            <p>
                                If products are manually synced using the button below, all products are synced to Stripe. To customize which products are synced to Stripe, specify a SOQL <code>WHERE</code> clause here.
                                This custom query determines which products will be synchronized when the "Sync All Products" button is pressed below. Products that do not meet the criteria defined here are excluded from the sync to Stripe.
                                This conditional will <strong>not</strong> limit which products connected to an activated order are synced.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <lightning-input label="Include Product records where:" type="text" value={productFilter} placeholder="Provide filter logic..." class={productFilterClassList} onchange={updateProductFilter}></lightning-input>
                            <div if:true={hasProductFilterError} class="slds-form-element__help slds-text-color_error">
                                {productFilterError}
                            </div>
                        </div>
                    </div>
                </c-sync-preferences-item>
                <c-sync-preferences-item name="pricebook_entry_filter" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                Custom PricebookEntry Sync Conditions
                            </h4>
                            <p>
                                If pricebooks are manually synced using the button below, all pricebooks are synced to Stripe. To customize which pricebooks are synced to Stripe, specify a SOQL <code>WHERE</code> clause here.
                                This custom query determines which pricebooks will be synchronized when the "Sync All Pricebooks" button is pressed below. PriceBooks that do not meet the criteria defined here are excluded from the sync to Stripe.
                                This conditional will <strong>not</strong> limit which pricebooks connected to an activated order are synced.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <lightning-input label="Include PricebookEntry records where:" type="text" value={priceBookFilter} placeholder="Provide filter logic..." class={priceBookFilterClassList} onchange={updatePriceBookFilter}></lightning-input>
                            <div if:true={hasPriceBookFilterError} class="slds-form-element__help slds-text-color_error">
                                {priceBookFilterError}
                            </div>
                        </div>
                    </div>
                </c-sync-preferences-item>
            </lightning-accordion-section>
            <lightning-accordion-section if:true={setupComplete} name="ManualSync" label="Manually Sync">
                <div if:true={isSandbox} class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Sync All Accounts
                        </h4>
                        <p>
                            Initiate a sync of all accounts in Salesforce to your Stripe account. This process will run in the background and can take a few minutes to complete depending on the number of accounts present. All accounts will be synced regardless of how recently they were updated. Be aware that accounts in Stripe will NOT be deleted or archived if they have been deleted in Salesforce.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3 slds-text-align_right">
                        <lightning-button label="Sync Accounts" variant="neutral" icon-name="utility:sync" icon-position="left" onclick={showAccountSyncModal} disabled={syncAccountsDisabled}></lightning-button>
                    </div>
                </div>

                <div if:true={isSandbox} class="stripe-settings__item slds-grid">
                    <div class="slds-col_bump-right">
                        <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                            Sync All Products
                        </h4>
                        <p>
                            Initiate a sync of all products in Salesforce to your Stripe account. This process will run in the background and can take a few minutes to complete depending on the number of products present. All products will be synced regardless of how recently they were updated. Be aware that products in Stripe will NOT be deleted or archived if they have been deleted in Salesforce.
                        </p>
                    </div>
                    <div class="slds-col slds-p-left_xx-large slds-size_1-of-3 slds-text-align_right">
                        <lightning-button label="Sync Products" variant="neutral" icon-name="utility:sync" icon-position="left" onclick={showProductSyncModal} disabled={syncProductsDisabled}></lightning-button>
                    </div>
                </div>

                <c-sync-preferences-item if:true={setupComplete} name="manual-translation" toggle-field-visibility-list={hiddenSyncPrefsFields}>
                    <div class="stripe-settings__item slds-grid">
                        <div class="slds-col_bump-right">
                            <h4 class="slds-text-heading_small slds-m-bottom_xx-small">
                                Manual Translation
                            </h4>
                            <p>
                                Provide a Salesforce Record Id to be synced to Stripe. By default, the record will
                                sync to your primary Stripe account unless otherwise specified on the Salesforce record using the
                                Stripe_Account__c field.
                            </p>
                        </div>
                        <div class="slds-col slds-p-left_xx-large slds-size_1-of-3">
                            <div class="slds-grid slds-gutters_direct-xxx-small">
                                <div class="slds-col">
                                    <lightning-input
                                            data-id="manualTranslationId"
                                            type="text"
                                            label="Target Record Id"
                                            variant="label-hidden"
                                            placeholder="Provide Record Id..."
                                            min-length="15"
                                            max-length="18"
                                            pattern="^(01s|01t|801|001)([0-9a-zA-Z]{12}|[0-9a-zA-Z]{15})$"
                                            message-when-pattern-mismatch="Id is not a valid Product, Account, Pricebook, or Order Id"
                                            message-when-too-short="Id length should be at least 15 characters."
                                            message-when-too-long="Id length should be less than 18 characters."
                                            value={manualTranslationValue}
                                            onchange={updateManualTranslationValue}
                                            disabled={disableManualTranslationId}>
                                    </lightning-input>
                                </div>
                                <div class="slds-col slds-no-flex">
                                    <lightning-button-icon
                                            icon-name="utility:send"
                                            variant="border-filled"
                                            alternative-text="Translate"
                                            disabled={disableManualTranslation}
                                            onclick={translateRecordId}>
                                    </lightning-button-icon>
                                </div>
                            </div>
                        </div>
                    </div>
                </c-sync-preferences-item>
            </lightning-accordion-section>
        </lightning-accordion>
    </div>

    <!-- Manual Sync Confirmation Modals -->
    <c-modal class="stripe-modal_product-sync" title="Sync All Products">
        <p class="slds-text-align_center">
            Are you sure you want to sync all products in your Salesforce org with your Stripe account? This process may
            take some time to complete and cannot be stopped once initiated.
            </p>
        <lightning-button slot="footer" label="Cancel" variant="neutral" class="slds-button"
            onclick={hideProductSyncModal}></lightning-button>
        <lightning-button slot="footer" label="Sync All Products" variant="brand" class="slds-button"
            onclick={syncProducts}></lightning-button>
    </c-modal>

    <c-modal class="stripe-modal_account-sync" title="Sync All Accounts">
        <p class="slds-text-align_center">
            Are you sure you want to sync all accounts in your Salesforce org with your Stripe account? This process may take some time to complete and
            cannot be stopped once initiated.
            </p>
        <lightning-button slot="footer" label="Cancel" variant="neutral" class="slds-button"
            onclick={hideAccountSyncModal}></lightning-button>
        <lightning-button slot="footer" label="Sync All Accounts" variant="brand" class="slds-button"
            onclick={syncAccounts}></lightning-button>
    </c-modal>
    <!-- /Manual Sync Confirmation Modals -->
</template>